<!doctype html>
<html lang="uz">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Login — ShaharTaxi</title>
  <style>
    body{font-family:Arial,Helvetica,sans-serif;background:#f7f9fc;margin:0;padding:0}
    .wrap{max-width:420px;margin:60px auto;padding:20px;background:#fff;border-radius:10px;box-shadow:0 6px 18px rgba(0,0,0,.06)}
    h2{color:#007bff;margin:0 0 12px}
    label{display:block;font-size:13px;margin-top:10px;color:#333}
    input{width:100%;padding:10px;border-radius:6px;border:1px solid #dcdcdc;margin-top:6px;box-sizing:border-box}
    button{margin-top:12px;padding:10px 12px;border-radius:8px;border:0;background:#007bff;color:#fff;cursor:pointer}
    .muted{font-size:13px;color:#666;margin-top:8px}
    .small{font-size:12px;color:#666}
    .err{color:#c0392b;margin-top:8px}
    #recaptcha-container{margin-top:12px}
    .link{margin-top:10px;display:block;text-align:center}
  </style>
</head>
<body>
  <div class="wrap">
    <h2>ShaharTaxi — Tizimga kirish</h2>

    <div>
      <label>Telefon raqam (format: +998901234567)</label>
      <input id="phoneInput" placeholder="+998901234567" />
      <div class="small muted">SMS kod qabul qilinadi. Faqat +998 bilan kiriting.</div>

      <div id="recaptcha-container"></div>

      <button id="sendBtn">Kod yuborish (SMS)</button>

      <div id="smsSection" style="display:none;">
        <label>SMS kodni kiriting</label>
        <input id="codeInput" placeholder="123456" />
        <button id="verifyBtn">Tasdiqlash</button>
      </div>

      <div id="status" class="err" style="display:none;"></div>

      <div class="link">
        <a href="profile.html">Profilga qaytish (profilga kirish uchun avval login kerak)</a>
      </div>
    </div>
  </div>

  <!-- Firebase (modular) -->
  <script type="module">
    // --- IMPORT ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import { getAuth, RecaptchaVerifier, signInWithPhoneNumber }
      from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";

    // --- CONFIG ---
    const firebaseConfig = {
      apiKey: "AIzaSyApWUG40YuC9aCsE9MOLXwLcYgRihREWvc",
      authDomain: "shahartaxi-demo.firebaseapp.com",
      projectId: "shahartaxi-demo",
      storageBucket: "shahartaxi-demo.firebasestorage.app",
      messagingSenderId: "874241795701",
      appId: "1:874241795701:web:89e9b20a3aed2ad8ceba3c"
    };

    // --- INIT ---
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);

    // DOM
    const phoneInput = document.getElementById('phoneInput');
    const sendBtn = document.getElementById('sendBtn');
    const smsSection = document.getElementById('smsSection');
    const codeInput = document.getElementById('codeInput');
    const verifyBtn = document.getElementById('verifyBtn');
    const statusBox = document.getElementById('status');

    let confirmationResult = null;
    let recaptchaVerifier = null;

    // reCAPTCHA INIT (AppCheck emas!)
    function initRecaptcha() {
      if (recaptchaVerifier) return;

      recaptchaVerifier = new RecaptchaVerifier(
        'recaptcha-container',
        { size: 'invisible' },
        auth
      );

      recaptchaVerifier.render().catch(e => {
        console.warn("reCAPTCHA render xatosi:", e);
      });
    }

    // SEND SMS
    sendBtn.addEventListener('click', async () => {
      statusBox.style.display = 'none';
      const phone = phoneInput.value.trim();

      if (!/^\+998\d{9}$/.test(phone)) {
        showError("Telefon raqamni to'g'ri kiriting (misol: +998901234567)");
        return;
      }

      initRecaptcha();

      try {
        confirmationResult = await signInWithPhoneNumber(auth, phone, recaptchaVerifier);
        smsSection.style.display = 'block';
        showStatus("✅ SMS yuborildi. Kodni kiriting.");
      } catch (err) {
        console.error("send SMS error", err);

        if (recaptchaVerifier?.clear) recaptchaVerifier.clear();
        recaptchaVerifier = null;
        initRecaptcha();

        showError("SMS yuborilmadi: " + (err.message || err));
      }
    });

    // VERIFY CODE
    verifyBtn.addEventListener('click', async () => {
      const code = codeInput.value.trim();

      if (!code) { showError("Kod kiriting."); return; }
      if (!confirmationResult) { showError("SMS yuborilmagan."); return; }

      try {
        const result = await confirmationResult.confirm(code);
        const user = result.user;

        const localUser = {
          id: user.uid || user.phoneNumber,
          phone: user.phoneNumber,
          name: user.phoneNumber
        };

        localStorage.setItem("currentUser", JSON.stringify(localUser));
        showStatus("✅ Kirish muvaffaqiyatli!...");
        setTimeout(() => location.href = "profile.html", 800);
      } catch (err) {
        console.error("verify error", err);
        showError("Kod noto‘g‘ri yoki xatolik: " + (err.message || err));
      }
    });

    // Helpers
    function showError(msg) {
      statusBox.style.display = 'block';
      statusBox.className = 'err';
      statusBox.textContent = msg;
    }

    function showStatus(msg) {
      statusBox.style.display = 'block';
      statusBox.className = 'small';
      statusBox.textContent = msg;
    }

    // Auto detect user
    auth.onAuthStateChanged(u => {
      if (u) {
        localStorage.setItem("currentUser", JSON.stringify({
          id: u.uid,
          phone: u.phoneNumber,
          name: u.phoneNumber
        }));
      }
    });

    // First render
    initRecaptcha();
  </script>
</body>
</html>
