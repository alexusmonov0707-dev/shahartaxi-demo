<!DOCTYPE html>
<html lang="uz">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin Statistika - ShaharTaxi</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background: #f4f6f9;
      margin: 0; padding: 0;
      text-align: center;
    }
    header {
      background: #007bff;
      color: white;
      padding: 1rem;
    }
    main {
      max-width: 1000px;
      margin: 2rem auto;
      background: white;
      padding: 1.5rem;
      border-radius: 10px;
      box-shadow: 0 3px 10px rgba(0,0,0,0.1);
    }
    .stats {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 1rem;
      margin-top: 1rem;
      text-align: left;
    }
    .stat-box {
      background: #f8f9fa;
      border-radius: 8px;
      padding: 1rem;
      border: 1px solid #e1e1e1;
    }
    .stat-box h3 { margin: 0; font-size: 1.1rem; color: #333; }
    .stat-box p { margin: 0.4rem 0 0; font-size: 1.3rem; font-weight: bold; }
    canvas { max-width: 800px; margin-top: 2rem; }
    button { background: #007bff; border: none; color: white; padding: 0.6rem 1.2rem; border-radius: 8px; cursor: pointer; margin-top: 2rem; }
    table { width: 100%; border-collapse: collapse; margin-top: 1.5rem; }
    th, td { border: 1px solid #ddd; padding: 8px; }
    th { background: #007bff; color: white; }
    tr:nth-child(even) { background: #f8f9fa; }

    /* small helpers for layout */
    .charts-grid { display: grid; grid-template-columns: 1fr; gap: 20px; }
    @media(min-width:900px){ .charts-grid { grid-template-columns: 1fr 1fr; } }
    .chart-card { background:#fff; padding:12px; border-radius:8px; box-shadow:0 2px 6px rgba(0,0,0,0.05); }
    .section-title { margin-top: 2rem; }
  </style>
</head>
<body>
  <header>
    <h1>ğŸ“Š ShaharTaxi Statistika</h1>
  </header>

  <main>
    <!-- Filtrlash panel (agar kerak bo'lsa) -->
    <!-- (Siz oldingi versiyada ham filtrlashni bordek o'zgartirishlarni qo'shishingiz mumkin) -->

    <h2>Umumiy maâ€™lumot</h2>
    <div class="stats">
      <div class="stat-box"><h3>Haydovchi eâ€™lonlar</h3><p id="driverCount">0</p></div>
      <div class="stat-box"><h3>Yoâ€˜lovchi eâ€™lonlar</h3><p id="passengerCount">0</p></div>
      <div class="stat-box"><h3>Tasdiqlangan</h3><p id="approvedCount">0</p></div>
      <div class="stat-box"><h3>Rad etilgan</h3><p id="rejectedCount">0</p></div>
      <div class="stat-box"><h3>Kutilmoqda</h3><p id="pendingCount">0</p></div>
    </div>

    <h2 class="section-title">Holatlar nisbati</h2>
    <div class="chart-card"><canvas id="statusChart"></canvas></div>

    <h2 class="section-title">Viloyatlar kesimida eâ€™lonlar</h2>
    <table>
      <thead><tr><th>Viloyat</th><th>Eâ€™lonlar soni</th></tr></thead>
      <tbody id="regionTableBody"><tr><td colspan="2">Maâ€™lumot yuklanmoqda...</td></tr></tbody>
    </table>
    <div class="chart-card"><canvas id="regionChart"></canvas></div>

    <h2 class="section-title">ğŸ“… Soâ€˜nggi 7 kunlik eâ€™lonlar trendlari</h2>
    <div class="chart-card"><canvas id="weeklyAdsChart"></canvas></div>

    <!-- Yangi qo'shilgan: 30 kunlik kunlik trend va holat trendlari -->
    <div class="charts-grid">
      <div>
        <h2 class="section-title">ğŸ“ˆ Soâ€˜nggi 30 kun - kunlik eâ€™lonlar (total)</h2>
        <div class="chart-card"><canvas id="thirtyDayChart"></canvas></div>
      </div>

      <div>
        <h2 class="section-title">ğŸ“Š Holat boâ€˜yicha 30 kunlik trend (approved / rejected / pending)</h2>
        <div class="chart-card"><canvas id="statusTrendChart"></canvas></div>
      </div>
    </div>

    <h2 class="section-title">ğŸ‘¥ Faol foydalanuvchilar</h2>
    <div class="stats">
      <div class="stat-box"><h3>Faol haydovchilar</h3><p id="activeDrivers">0</p></div>
      <div class="stat-box"><h3>Faol yoâ€˜lovchilar</h3><p id="activePassengers">0</p></div>
      <div class="stat-box" style="grid-column: span 2;"><h3>Eng faol foydalanuvchi</h3><p id="topUser">Aniqlanmoqda...</p></div>
    </div>
    <div class="chart-card"><canvas id="userChart"></canvas></div>

    <button onclick="location.href='admin.html'">â¬…ï¸ Admin panelga qaytish</button>
  </main>

  <script>
    /* Helper: is valid Date */
    function isValidDate(d){
      return d instanceof Date && !isNaN(d);
    }

    // parseAdDate: robust parser that handles multiple stored formats
    function parseAdDate(dateStr){
      if (!dateStr) return null;
      // If it's already a Date object, return
      if (dateStr instanceof Date) return dateStr;

      // Try ISO / general parse first
      const tryDate = new Date(dateStr);
      if (isValidDate(tryDate)) return tryDate;

      // Try numeric timestamp
      if (!isNaN(Number(dateStr))) {
        const t = new Date(Number(dateStr));
        if (isValidDate(t)) return t;
      }

      // Try format: DD.MM.YYYY or DD.MM.YYYY HH:mm
      const match = String(dateStr).match(/^(\d{2})\.(\d{2})\.(\d{4})(?:[ T](\d{2}):(\d{2})(?::(\d{2}))?)?$/);
      if (match){
        const day = Number(match[1]), month = Number(match[2]), year = Number(match[3]);
        const hour = Number(match[4]||0), minute = Number(match[5]||0), second = Number(match[6]||0);
        const dt = new Date(year, month-1, day, hour, minute, second);
        if (isValidDate(dt)) return dt;
      }

      // Try locale-ish formats like "11/4/2025, 3:00:00 PM" â€” new Date tried that above, but fallback:
      // Extract numbers from common patterns
      const altMatch = String(dateStr).match(/(\d{1,4})[\/\.\-](\d{1,2})[\/\.\-](\d{2,4})/);
      if (altMatch){
        // best effort: try Date again
        const d2 = new Date(dateStr);
        if (isValidDate(d2)) return d2;
      }

      return null;
    }

    const ctx = document.getElementById('statusChart').getContext('2d');
    const regionCtx = document.getElementById('regionChart').getContext('2d');
    const weeklyCtx = document.getElementById('weeklyAdsChart').getContext('2d');
    const thirtyCtx = document.getElementById('thirtyDayChart').getContext('2d');
    const statusTrendCtx = document.getElementById('statusTrendChart').getContext('2d');
    const userCtx = document.getElementById('userChart').getContext('2d');

    let statusChart, regionChart, weeklyChart, thirtyChart, statusTrendChart, userChart;

    function loadStats(){
      const stats = JSON.parse(localStorage.getItem('stats')) || { drivers:0, passengers:0, approved:0, rejected:0, pending:0 };

      document.getElementById('driverCount').innerText = stats.drivers;
      document.getElementById('passengerCount').innerText = stats.passengers;
      document.getElementById('approvedCount').innerText = stats.approved;
      document.getElementById('rejectedCount').innerText = stats.rejected;
      document.getElementById('pendingCount').innerText = stats.pending;

      const data = [stats.approved, stats.rejected, stats.pending];
      if (!statusChart){
        statusChart = new Chart(ctx, {
          type: 'pie',
          data: { labels: ['Tasdiqlangan','Rad etilgan','Kutilmoqda'], datasets:[{ data, backgroundColor:['#28a745','#dc3545','#ffc107'] }] },
          options: { responsive:true }
        });
      } else {
        statusChart.data.datasets[0].data = data;
        statusChart.update();
      }

      loadRegionStats();
      loadWeeklyTrends();
      load30DayTrends();
      loadStatusTrend30();
      loadUserStats();
    }

    function loadRegionStats(){
      const driverAds = JSON.parse(localStorage.getItem('driverAds')) || [];
      const passengerAds = JSON.parse(localStorage.getItem('passengerAds')) || [];
      const allAds = [...driverAds, ...passengerAds];

      const regionCounts = {};
      allAds.forEach(ad => {
        const region = ad.fromRegion || ad.toRegion || 'Nomaâ€™lum';
        regionCounts[region] = (regionCounts[region] || 0) + 1;
      });

      const tbody = document.getElementById('regionTableBody');
      tbody.innerHTML = '';
      const regions = Object.keys(regionCounts);
      if (regions.length === 0) {
        tbody.innerHTML = '<tr><td colspan="2">Eâ€™lonlar topilmadi.</td></tr>';
      } else {
        regions.forEach(region => {
          const tr = document.createElement('tr');
          tr.innerHTML = `<td>${region}</td><td>${regionCounts[region]}</td>`;
          tbody.appendChild(tr);
        });
      }

      const chartData = { labels: regions, datasets:[{ label:'Eâ€™lonlar soni', data:Object.values(regionCounts), backgroundColor:'#007bff' }] };
      if (!regionChart){
        regionChart = new Chart(regionCtx, { type:'bar', data:chartData, options:{ responsive:true, indexAxis:'y', scales:{ x:{ beginAtZero:true } } }});
      } else {
        regionChart.data = chartData;
        regionChart.update();
      }
    }

    // Weekly (7 days) trend â€” keeps previous behavior but robust to different createdAt formats
    function loadWeeklyTrends(){
      const driverAds = JSON.parse(localStorage.getItem('driverAds')) || [];
      const passengerAds = JSON.parse(localStorage.getItem('passengerAds')) || [];
      const allAds = [...driverAds, ...passengerAds];

      const now = new Date();
      const last7 = Array.from({length:7}, (_,i) => {
        const d = new Date(now);
        d.setDate(now.getDate() - (6 - i));
        // return date string in YYYY-MM-DD to compare easily
        return d.toISOString().split('T')[0];
      });

      const counts = last7.map(dayStr => {
        return allAds.filter(ad => {
          if (!ad.createdAt) return false;
          const dt = parseAdDate(ad.createdAt);
          if (!isValidDate(dt)) return false;
          return dt.toISOString().split('T')[0] === dayStr;
        }).length;
      });

      const data = { labels:last7, datasets:[{ label:'Soâ€˜nggi 7 kunlik eâ€™lonlar', data:counts, fill:false, borderColor:'#007bff', tension:0.3 }] };
      if (!weeklyChart){
        weeklyChart = new Chart(weeklyCtx, { type:'line', data, options:{ responsive:true, scales:{ y:{ beginAtZero:true } } }});
      } else {
        weeklyChart.data = data;
        weeklyChart.update();
      }
    }

    // New: 30-day total daily counts
    function load30DayTrends(){
      const driverAds = JSON.parse(localStorage.getItem('driverAds')) || [];
      const passengerAds = JSON.parse(localStorage.getItem('passengerAds')) || [];
      const allAds = [...driverAds, ...passengerAds];

      const now = new Date();
      const last30 = Array.from({length:30}, (_,i) => {
        const d = new Date(now);
        d.setDate(now.getDate() - (29 - i));
        return d.toISOString().split('T')[0];
      });

      const counts = last30.map(dayStr => {
        return allAds.filter(ad => {
          if (!ad.createdAt) return false;
          const dt = parseAdDate(ad.createdAt);
          if (!isValidDate(dt)) return false;
          return dt.toISOString().split('T')[0] === dayStr;
        }).length;
      });

      const data = { labels:last30, datasets:[{ label:'Kunlik eâ€™lonlar (30 kun)', data:counts, fill:false, borderColor:'#17a2b8', tension:0.2 }] };

      if (!thirtyChart){
        thirtyChart = new Chart(thirtyCtx, { type:'line', data, options:{ responsive:true, scales:{ y:{ beginAtZero:true } } }});
      } else {
        thirtyChart.data = data;
        thirtyChart.update();
      }
    }

    // New: status-specific 30-day trends (approved, rejected, pending)
    function loadStatusTrend30(){
      const driverAds = JSON.parse(localStorage.getItem('driverAds')) || [];
      const passengerAds = JSON.parse(localStorage.getItem('passengerAds')) || [];
      const allAds = [...driverAds, ...passengerAds];

      const now = new Date();
      const last30 = Array.from({length:30}, (_,i) => {
        const d = new Date(now);
        d.setDate(now.getDate() - (29 - i));
        return d.toISOString().split('T')[0];
      });

      const approvedCounts = last30.map(dayStr => 0);
      const rejectedCounts = last30.map(dayStr => 0);
      const pendingCounts = last30.map(dayStr => 0);

      allAds.forEach(ad => {
        if (!ad.createdAt) return;
        const dt = parseAdDate(ad.createdAt);
        if (!isValidDate(dt)) return;
        const dayKey = dt.toISOString().split('T')[0];
        const idx = last30.indexOf(dayKey);
        if (idx === -1) return;
        const status = ad.status || 'pending';
        if (status === 'approved') approvedCounts[idx]++;
        else if (status === 'rejected') rejectedCounts[idx]++;
        else pendingCounts[idx]++;
      });

      const data = {
        labels: last30,
        datasets: [
          { label: 'Tasdiqlangan', data: approvedCounts, borderColor:'#28a745', fill:false, tension:0.2 },
          { label: 'Rad etilgan', data: rejectedCounts, borderColor:'#dc3545', fill:false, tension:0.2 },
          { label: 'Kutilmoqda', data: pendingCounts, borderColor:'#ffc107', fill:false, tension:0.2 }
        ]
      };

      if (!statusTrendChart){
        statusTrendChart = new Chart(statusTrendCtx, { type:'line', data, options:{ responsive:true, scales:{ y:{ beginAtZero:true } } }});
      } else {
        statusTrendChart.data = data;
        statusTrendChart.update();
      }
    }

    function loadUserStats(){
      const driverAds = JSON.parse(localStorage.getItem('driverAds')) || [];
      const passengerAds = JSON.parse(localStorage.getItem('passengerAds')) || [];
      const allAds = [...driverAds, ...passengerAds];

      const userCounts = {};
      allAds.forEach(ad => {
        const user = ad.phone || 'Nomaâ€™lum';
        userCounts[user] = (userCounts[user] || 0) + 1;
      });

      const activeDrivers = new Set(driverAds.map(ad => ad.phone)).size;
      const activePassengers = new Set(passengerAds.map(ad => ad.phone)).size;
      document.getElementById('activeDrivers').innerText = activeDrivers;
      document.getElementById('activePassengers').innerText = activePassengers;

      const topUser = Object.entries(userCounts).sort((a,b)=>b[1]-a[1])[0];
      document.getElementById('topUser').innerText = topUser ? `${topUser[0]} (${topUser[1]} eâ€™lon)` : 'Maâ€™lumot yoâ€˜q';

      const chartData = { labels:Object.keys(userCounts), datasets:[{ label:'Eâ€™lonlar soni (foydalanuvchi boâ€˜yicha)', data:Object.values(userCounts), backgroundColor:'#17a2b8' }] };
      if (!userChart){
        userChart = new Chart(userCtx, { type:'bar', data:chartData, options:{ responsive:true, scales:{ y:{ beginAtZero:true } } }});
      } else {
        userChart.data = chartData;
        userChart.update();
      }
    }

    // Filtrlash (oldingi dialogga mos)
    function applyFilters(){
      // If you want to display count / table results based on filters â€” current function just alerts count like before
      const typeSelect = document.getElementById('adTypeFilter');
      const statusSelect = document.getElementById('statusFilter');
      const fromDateInput = document.getElementById('fromDate');
      const toDateInput = document.getElementById('toDate');

      const type = typeSelect ? typeSelect.value : 'all';
      const status = statusSelect ? statusSelect.value : 'all';
      const fromDate = fromDateInput && fromDateInput.value ? new Date(fromDateInput.value) : null;
      const toDate = toDateInput && toDateInput.value ? new Date(toDateInput.value) : null;

      const driverAds = JSON.parse(localStorage.getItem('driverAds')) || [];
      const passengerAds = JSON.parse(localStorage.getItem('passengerAds')) || [];
      let allAds = [...driverAds, ...passengerAds];

      if (type === 'driver') allAds = driverAds;
      else if (type === 'passenger') allAds = passengerAds;

      if (status !== 'all') {
        allAds = allAds.filter(ad => (ad.status||'pending') === status);
      }

      if (fromDate || toDate) {
        allAds = allAds.filter(ad => {
          const dt = parseAdDate(ad.createdAt);
          if (!isValidDate(dt)) return false;
          // normalize time for fromDate/toDate comparisons: set to start/end of day
          const start = fromDate ? new Date(fromDate.getFullYear(), fromDate.getMonth(), fromDate.getDate(), 0,0,0) : null;
          const end = toDate ? new Date(toDate.getFullYear(), toDate.getMonth(), toDate.getDate(), 23,59,59) : null;
          return (!start || dt >= start) && (!end || dt <= end);
        });
      }

      alert(`Topilgan eâ€™lonlar: ${allAds.length} ta`);
    }

    // Initialize
    loadStats();
    // Auto-refresh charts/stats every 5s (like admin other pages)
    setInterval(loadStats, 5000);
  </script>
</body>
</html>
