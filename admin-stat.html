<!DOCTYPE html>
<html lang="uz">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Statistika - ShaharTaxi</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: 'Inter',sans-serif; background:#f7fbff; margin:0; }
    header { background:#007bff; color:#fff; padding:1rem; text-align:center; font-weight:600; }
    main { max-width:900px; margin:2rem auto; background:#fff; padding:1.5rem; border-radius:10px; box-shadow:0 4px 12px rgba(0,0,0,0.06); }
    .stats { display:flex; gap:1rem; justify-content:space-around; margin-bottom:1rem; }
    .card { text-align:center; padding:0.8rem; border-radius:8px; background:#eef6ff; width:30%; }
    canvas { max-width:100%; }
    .small { color:#666; font-size:0.9rem; text-align:center; margin-top:0.6rem; }
  </style>
</head>
<body>
  <header>📊 ShaharTaxi — Statistika</header>
  <main>
    <div class="stats">
      <div class="card"><div>Tasdiqlangan</div><h2 id="approvedCount">0</h2></div>
      <div class="card"><div>Kutilmoqda</div><h2 id="pendingCount">0</h2></div>
      <div class="card"><div>Jami</div><h2 id="totalCount">0</h2></div>
    </div>

    <canvas id="adsChart"></canvas>
    <p class="small">🔄 Sahifa avtomatik yangilanadi. (storage event + interval)</p>
    <button style="display:block;margin:1rem auto;padding:0.5rem 1rem;border-radius:8px;border:none;background:#007bff;color:#fff;cursor:pointer;" onclick="window.close()">❎ Yopish</button>
  </main>

  <script>
    let chartInstance = null;

    function computeStatsAndRender() {
      const driverAds = JSON.parse(localStorage.getItem('driverAds')) || [];
      const passengerAds = JSON.parse(localStorage.getItem('passengerAds')) || [];
      const all = [...driverAds, ...passengerAds];

      const approved = all.filter(a => a.approved).length;
      const pending = all.length - approved;
      const total = all.length;

      document.getElementById('approvedCount').innerText = approved;
      document.getElementById('pendingCount').innerText = pending;
      document.getElementById('totalCount').innerText = total;

      const data = [approved, pending];
      const ctx = document.getElementById('adsChart').getContext('2d');

      if (chartInstance) {
        chartInstance.data.datasets[0].data = data;
        chartInstance.update();
      } else {
        chartInstance = new Chart(ctx, {
          type: 'doughnut',
          data: {
            labels: ['Tasdiqlangan','Kutilmoqda'],
            datasets: [{ data, backgroundColor: ['#28a745','#ffc107'] }]
          },
          options: { responsive:true, plugins:{ legend:{ position:'bottom' } } }
        });
      }
    }

    // Listen for storage events from other tabs (fast sync)
    window.addEventListener('storage', (e) => {
      if (e.key === 'lastUpdate' || e.key === 'driverAds' || e.key === 'passengerAds') {
        computeStatsAndRender();
      }
    });

    // Fallback periodic update
    computeStatsAndRender();
    setInterval(computeStatsAndRender, 5000);
  </script>
</body>
</html>
