<!DOCTYPE html>
<html lang="uz">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin panel - ShaharTaxi</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <style>
    body { font-family:'Inter',sans-serif; background:#f2f6fc; margin:0; }
    header { background:#007bff; color:#fff; padding:1rem; text-align:center; font-size:1.3rem; }
    main { max-width:1000px; margin:1.5rem auto; background:#fff; padding:1.2rem; border-radius:10px; box-shadow:0 4px 12px rgba(0,0,0,0.08); }
    .top { display:flex; justify-content:space-between; align-items:center; gap:1rem; flex-wrap:wrap; }
    .btn { padding:0.5rem 0.9rem; border-radius:8px; border:none; cursor:pointer; font-weight:600; }
    .btn-primary { background:#007bff; color:#fff; }
    .btn-ghost { background:transparent; border:1px solid #007bff; color:#007bff; }
    .ad { border:1px solid #e6e9ef; padding:0.9rem; border-radius:8px; margin-top:0.9rem; background:#fff; }
    .ad h4 { margin:0 0 0.4rem 0; }
    .actions { margin-top:0.6rem; }
    .approve{ background:#28a745; color:#fff; } .edit{ background:#ffc107; } .reject{ background:#dc3545; color:#fff; }
  </style>
</head>
<body>
  <header>üõ† ShaharTaxi ‚Äî Admin panel</header>

  <main>
    <div class="top">
      <div>
        <button class="btn btn-primary" id="refreshBtn">üîÅ Yangilash</button>
        <button class="btn btn-ghost" id="openStatsBtn">üìä Statistikaga o‚Äòtish</button>
      </div>
      <div>
        <small id="statusInfo" style="color:#555;">Oxirgi o‚Äòzgarish: ‚Äî</small>
      </div>
    </div>

    <div id="adsContainer"></div>
  </main>

  <script>
    // Helper: write lastUpdate timestamp to localStorage to notify other tabs/pages
    function notifyChange() {
      const ts = Date.now();
      localStorage.setItem('lastUpdate', ts.toString());
      // Also update human-readable time for this page
      document.getElementById('statusInfo').innerText = 'Oxirgi o‚Äòzgarish: ' + new Date(ts).toLocaleString();
    }

    // Load and render ads, splitting driver and passenger properly
    function loadAds() {
      const driverAds = JSON.parse(localStorage.getItem('driverAds')) || [];
      const passengerAds = JSON.parse(localStorage.getItem('passengerAds')) || [];
      const container = document.getElementById('adsContainer');
      container.innerHTML = '';

      // Drivers
      if (driverAds.length) {
        const t = document.createElement('h3'); t.innerText = 'üöó Haydovchi e\'lonlari'; container.appendChild(t);
        driverAds.forEach((ad, idx) => {
          const el = document.createElement('div'); el.className = 'ad';
          el.innerHTML = `
            <h4>üìç ${ad.fromRegion || '-'} ${ad.fromDistrict || ''} ‚Üí ${ad.toRegion || '-'} ${ad.toDistrict || ''}</h4>
            <div>Haydovchi: <b>${ad.driver || '-'}</b></div>
            <div>Tel: <b>${ad.phone || '-'}</b></div>
            <div>Narx: <b>${ad.price || '-'}</b></div>
            <div>Holat: <b>${ad.approved ? '‚úÖ Tasdiqlangan' : '‚è≥ Kutilmoqda'}</b></div>
            <div class="actions">
              <button class="btn approve" onclick="approveAd('driver', ${idx})">Tasdiqlash</button>
              <button class="btn edit" onclick="editAd('driver', ${idx})">Tahrirlash</button>
              <button class="btn reject" onclick="rejectAd('driver', ${idx})">Rad etish</button>
            </div>
          `;
          container.appendChild(el);
        });
      }

      // Passengers
      if (passengerAds.length) {
        const t2 = document.createElement('h3'); t2.innerText = 'üßç Yo‚Äòlovchi e\'lonlari'; container.appendChild(t2);
        passengerAds.forEach((ad, idx) => {
          const el = document.createElement('div'); el.className = 'ad';
          el.innerHTML = `
            <h4>üìç ${ad.fromRegion || '-'} ${ad.fromDistrict || ''} ‚Üí ${ad.toRegion || '-'} ${ad.toDistrict || ''}</h4>
            <div>Ism: <b>${ad.name || '-'}</b></div>
            <div>Tel: <b>${ad.phone || '-'}</b></div>
            <div>Narx: <b>${ad.price || '-'}</b></div>
            <div>Holat: <b>${ad.approved ? '‚úÖ Tasdiqlangan' : '‚è≥ Kutilmoqda'}</b></div>
            <div class="actions">
              <button class="btn approve" onclick="approveAd('passenger', ${idx})">Tasdiqlash</button>
              <button class="btn edit" onclick="editAd('passenger', ${idx})">Tahrirlash</button>
              <button class="btn reject" onclick="rejectAd('passenger', ${idx})">Rad etish</button>
            </div>
          `;
          container.appendChild(el);
        });
      }

      // Update statusInfo from lastUpdate if exists
      const last = localStorage.getItem('lastUpdate');
      if (last) document.getElementById('statusInfo').innerText = 'Oxirgi o‚Äòzgarish: ' + new Date(parseInt(last)).toLocaleString();
    }

    // Approve sets approved=true and notifies
    function approveAd(type, index) {
      const key = type === 'driver' ? 'driverAds' : 'passengerAds';
      const ads = JSON.parse(localStorage.getItem(key)) || [];
      if (!ads[index]) return alert('E‚Äôlon topilmadi');
      ads[index].approved = true;
      localStorage.setItem(key, JSON.stringify(ads));
      notifyChange();
      loadAds();
    }

    // Reject removes ad from storage and notifies
    function rejectAd(type, index) {
      const key = type === 'driver' ? 'driverAds' : 'passengerAds';
      const ads = JSON.parse(localStorage.getItem(key)) || [];
      if (!ads[index]) return alert('E‚Äôlon topilmadi');
      if (!confirm('E‚Äôlonni haqiqatan ham rad etasizmi?')) return;
      ads.splice(index,1);
      localStorage.setItem(key, JSON.stringify(ads));
      notifyChange();
      loadAds();
    }

    // Edit allows phone/price (and name/driver) edit; then notify
    function editAd(type, index) {
      const key = type === 'driver' ? 'driverAds' : 'passengerAds';
      const ads = JSON.parse(localStorage.getItem(key)) || [];
      if (!ads[index]) return alert('E‚Äôlon topilmadi');
      const ad = ads[index];
      const newPhone = prompt('Telefon raqam:', ad.phone || '');
      if (newPhone === null) return; // cancel
      ad.phone = newPhone;
      const newPrice = prompt('Narx (so‚Äòm):', ad.price || '');
      if (newPrice !== null) ad.price = newPrice;
      // allow editing names
      if (type === 'driver') {
        const newDriver = prompt('Haydovchi ismi:', ad.driver || '');
        if (newDriver !== null) ad.driver = newDriver;
      } else {
        const newName = prompt('Ism:', ad.name || '');
        if (newName !== null) ad.name = newName;
      }
      localStorage.setItem(key, JSON.stringify(ads));
      notifyChange();
      loadAds();
    }

    // Open admin-stat.html in new tab/window and keep reference
    let statsWindow = null;
    document.getElementById('openStatsBtn').addEventListener('click', () => {
      // Open in new tab (will reuse if already opened)
      if (!statsWindow || statsWindow.closed) {
        statsWindow = window.open('admin-stat.html', '_blank');
      } else {
        statsWindow.focus();
      }
    });

    // Manual refresh button
    document.getElementById('refreshBtn').addEventListener('click', () => {
      loadAds();
    });

    // Respond to storage changes made in other tabs (so UI updates immediately)
    window.addEventListener('storage', (e) => {
      if (e.key === 'lastUpdate' || e.key === 'driverAds' || e.key === 'passengerAds') {
        loadAds();
      }
    });

    // Initial load + periodic refresh (backup)
    loadAds();
    setInterval(loadAds, 5000);
  </script>
</body>
</html>
