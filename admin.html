<!DOCTYPE html>
<html lang="uz">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin Panel - ShaharTaxi</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; background: #f4f6f9; margin: 0; padding: 0; }
    header { background: #007bff; color: white; padding: 1rem; text-align: center; }
    main { max-width: 1100px; margin: 1rem auto; background: white; border-radius: 10px; padding: 1.2rem; box-shadow: 0 3px 10px rgba(0,0,0,0.1); }
    .controls { display:flex; gap:8px; flex-wrap:wrap; margin-bottom:12px; align-items:center; }
    input[type="text"], select { padding: 8px; border-radius:6px; border:1px solid #ccc; }
    button { padding:8px 10px; border-radius:6px; border:none; background:#007bff; color:white; cursor:pointer; }
    button.secondary { background:#6c757d; }
    .ad { border-bottom:1px solid #ddd; padding:12px 0; position:relative; display:flex; gap:12px; align-items:flex-start; }
    .ad:last-child{ border-bottom:none; }
    .ad-left { width:36px; display:flex; align-items:center; }
    .ad-body { flex:1; }
    .ad-meta { font-size:0.95rem; color:#333; }
    .actions { display:flex; gap:6px; margin-top:8px; }
    .approve { background:#28a745; }
    .reject { background:#dc3545; }
    .edit { background:#ffc107; color:black; }
    .delete { background:#6c757d; }
    .status { font-weight:600; }
    .inline-edit-input { width:120px; padding:6px; border-radius:6px; border:1px solid #ccc; }
    .modal { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.4); align-items:center; justify-content:center; z-index:9999; }
    .modal-content { background:white; padding:16px; border-radius:8px; width:360px; box-shadow:0 3px 12px rgba(0,0,0,0.2); }
    .pagination { display:flex; gap:6px; margin-top:10px; align-items:center; }
    .file-input { display:none; }
    .top-row { display:flex; gap:8px; align-items:center; justify-content:space-between; margin-bottom:8px; }
    .bulk-actions { display:flex; gap:6px; }
    .small-btn { padding:6px 8px; font-size:0.9rem; }
    .info { font-size:0.9rem; color:#555; }
    @media (max-width:720px){ .ad { flex-direction:column; } .ad-left{ width:100% } }

    /* üìä Statistikalar */
    #statsSection { display:flex;flex-wrap:wrap;gap:12px;justify-content:center;margin:16px auto;max-width:1100px; }
    .stat-card { flex:1;min-width:220px;padding:16px;border-radius:10px;text-align:center;color:white; }
    .blue { background:#007bff; }
    .green { background:#28a745; }
    .yellow { background:#ffc107;color:black; }
    .red { background:#dc3545; }
  </style>
</head>
<body>

  <!-- LOGIN OVERLAY -->
  <div id="loginOverlay" style="display:none;">
    <div class="login-box" style="background:#fff;padding:24px;border-radius:12px;width:360px;margin:auto;">
      <h3>üîê Admin kirish</h3>
      <input type="text" id="adminUser" placeholder="Foydalanuvchi" value="admin" style="width:100%;padding:8px;margin:8px 0;border-radius:8px;border:1px solid #ccc;">
      <input type="password" id="adminPass" placeholder="Parol" style="width:100%;padding:8px;margin:8px 0;border-radius:8px;border:1px solid #ccc;">
      <p id="loginError" style="color:red;margin:8px 0 0 0"></p>
      <button onclick="checkAdminLogin()">Kirish</button>
    </div>
  </div>

  <header><h1>üõ† ShaharTaxi - Admin Panel</h1></header>

  <!-- üìä STATISTIKA KARTALARI -->
  <section id="statsSection">
    <div class="stat-card blue">
      <h3 id="totalAds">0</h3>
      <p>Barcha e‚Äôlonlar</p>
    </div>
    <div class="stat-card green">
      <h3 id="approvedAds">0</h3>
      <p>Tasdiqlangan</p>
    </div>
    <div class="stat-card yellow">
      <h3 id="pendingAds">0</h3>
      <p>Kutilayotgan</p>
    </div>
    <div class="stat-card red">
      <h3 id="rejectedAds">0</h3>
      <p>Rad etilgan</p>
    </div>
  </section>

  <main>
    <div class="top-row">
      <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center;">
        <input type="text" id="searchInput" placeholder="Qidirish: telefon yoki ID..." oninput="onSearchChange()" style="padding:8px;border-radius:6px;border:1px solid #ccc;">
        <select id="typeFilter" onchange="renderAds()">
          <option value="all">Barcha turlar</option>
          <option value="driver">Haydovchilar</option>
          <option value="passenger">Yo‚Äòlovchilar</option>
        </select>
        <select id="statusFilter" onchange="renderAds()">
          <option value="all">Barcha holatlar</option>
          <option value="pending">Kutilmoqda</option>
          <option value="approved">Tasdiqlangan</option>
          <option value="rejected">Rad etilgan</option>
        </select>
        <select id="sortFilter" onchange="renderAds()">
          <option value="desc">Eng yangi avval</option>
          <option value="asc">Eng eski avval</option>
        </select>
      </div>

      <div style="display:flex;gap:8px;align-items:center;">
        <div class="bulk-actions">
          <button class="small-btn" onclick="selectAllToggle()">‚¨ú Barchasini tanlash</button>
          <button class="small-btn" onclick="bulkUpdateStatus('approved')">‚úÖ Tasdiqlash</button>
          <button class="small-btn" onclick="bulkUpdateStatus('rejected')">‚ùå Rad etish</button>
        </div>

        <button onclick="exportAllCSV()">Export CSV</button>
        <label style="display:inline-block;">
          <input type="file" id="csvImport" class="file-input" accept=".csv" onchange="importCSV(this.files)" />
          <button class="secondary" onclick="document.getElementById('csvImport').click()">Import CSV</button>
        </label>

        <button onclick="standardizeDates()">üßπ Fix dates</button>
        <button onclick="toggleNotifications()">üîî Notifications</button>
        <button onclick="logoutAdmin()" style="background:#6c757d;">Chiqish</button>
      </div>
    </div>

    <div class="controls info">
      <span id="adsInfo">E‚Äôlonlar yuklanmoqda...</span>
    </div>

    <div id="ads"></div>

    <div class="pagination" id="paginationControls"></div>

    <!-- Edit Modal -->
    <div class="modal" id="editModal">
      <div class="modal-content">
        <h3>E‚Äôlonni tahrirlash</h3>
        <input type="text" id="editPhone" placeholder="Telefon raqam">
        <input type="text" id="editPrice" placeholder="Narx (so‚Äòm)">
        <input type="text" id="editFrom" placeholder="Qayerdan">
        <input type="text" id="editTo" placeholder="Qayerga">
        <select id="editStatus">
          <option value="pending">Kutilmoqda</option>
          <option value="approved">Tasdiqlangan</option>
          <option value="rejected">Rad etilgan</option>
        </select>
        <div style="margin-top:8px;">
          <button class="save-btn" onclick="saveEdit()">Saqlash</button>
          <button class="cancel-btn" onclick="closeModal()">Bekor qilish</button>
        </div>
      </div>
    </div>

    <!-- History Modal -->
    <div class="modal" id="historyModal">
      <div class="modal-content">
        <h3>Tasdiqlash tarixi</h3>
        <div id="historyList"></div>
        <button class="cancel-btn" onclick="closeHistory()">Yopish</button>
      </div>
    </div>

  </main>

  <!--
    NOTE:
    admin.js (sening original) yuklanadi ‚Äî uning ichidagi barcha funksiyalar o'z joyida qoladi.
    Quyidagi <script> esa faqat statistikani yangilash va barqaror hisoblash uchun qo'shilgan.
  -->
  <script src="admin.js"></script>

  <script>
    // ---- Robust stats updater (does NOT remove/change any admin.js logic) ----

    // Normalize status from various legacy forms
    function _normalizeStatus(s) {
      if (!s && s !== 0) return 'pending';
      s = String(s).toLowerCase().trim();
      if (s === '') return 'pending';
      if (s.includes('approved') || s.includes('tasdiq') || s.includes('tasdiqlangan') || s === '1' || s === 'true') return 'approved';
      if (s.includes('rejected') || s.includes('rad') || s.includes('reject')) return 'rejected';
      if (s.includes('pending') || s.includes('kut') || s.includes('pend')) return 'pending';
      // fallback: if it's one of allowed statuses
      if (['approved','rejected','pending'].includes(s)) return s;
      return 'pending';
    }

    // Read all ads from known keys and return unique-by-id array
    function _gatherAllAdsUnique() {
      const keys = ['ads', 'driverAds', 'passengerAds'];
      const map = new Map();
      keys.forEach(k => {
        try {
          const arr = JSON.parse(localStorage.getItem(k)) || [];
          if (Array.isArray(arr)) {
            arr.forEach(ad => {
              // If no id present, create a synthetic id based on content (to avoid merging distinct ones)
              let id = (ad && (ad.id || ad.ID || ad._id)) ? String(ad.id || ad.ID || ad._id) : null;
              if (!id) {
                // generate stable-ish id using createdAt+phone+from+to if possible
                id = 'gen_' + (ad.createdAt || '') + '|' + (ad.phone || '') + '|' + (ad.fromRegion||ad.from||'') + '|' + (ad.toRegion||ad.to||'');
              }
              // ensure unique by id: prefer explicit id if available
              if (!map.has(id)) {
                map.set(String(id), Object.assign({}, ad, { id: String(id) }));
              } else {
                // if duplicate exists, we can merge fields (keep the one that has more data)
                const existing = map.get(String(id));
                // prefer object with createdAt or phone if existing lacks
                const merged = Object.assign({}, existing, ad);
                map.set(String(id), merged);
              }
            });
          }
        } catch (e) {
          console.warn('Stats: could not parse', k, e);
        }
      });
      return Array.from(map.values());
    }

    function updateStatsUI() {
      const allAds = _gatherAllAdsUnique();

      // Normalize statuses and count
      let total = allAds.length;
      let approved = 0, rejected = 0, pending = 0;
      allAds.forEach(a => {
        const st = _normalizeStatus(a.status);
        if (st === 'approved') approved++;
        else if (st === 'rejected') rejected++;
        else pending++;
      });

      // Update DOM
      const totalEl = document.getElementById('totalAds');
      const approvedEl = document.getElementById('approvedAds');
      const pendingEl = document.getElementById('pendingAds');
      const rejectedEl = document.getElementById('rejectedAds');

      if (totalEl) totalEl.textContent = total;
      if (approvedEl) approvedEl.textContent = approved;
      if (pendingEl) pendingEl.textContent = pending;
      if (rejectedEl) rejectedEl.textContent = rejected;

      // update info line if exists
      const info = document.getElementById('adsInfo');
      if (info) info.textContent = `Topilgan e‚Äôlonlar: ${total} (Tasdiqlangan ${approved}, Kutilmoqda ${pending}, Rad etilgan ${rejected})`;
    }

    // Run on load
    window.addEventListener('load', () => {
      // initial run a bit later to allow admin.js to initialize data
      setTimeout(updateStatsUI, 200);
    });

    // storage events -> update
    window.addEventListener('storage', (e) => {
      // if any ads key changed, update immediately
      if (['ads','driverAds','passengerAds','approvalHistory','userNotifications'].includes(e.key)) {
        updateStatsUI();
      }
    });

    // periodic safety update
    setInterval(updateStatsUI, 3000);

    // Also try to chain with adminRefresh if present (so when other scripts call adminRefresh we also update stats)
    (function chainAdminRefresh() {
      const orig = window.adminRefresh;
      window.adminRefresh = function() {
        try { if (typeof orig === 'function') orig(); } catch(e) { console.warn('adminRefresh orig error', e); }
        try { updateStatsUI(); } catch(e){ console.warn('updateStatsUI error', e); }
      };
    })();

    // expose for debugging
    window._updateAdminStats = updateStatsUI;
  </script>

</body>
</html>
