<!DOCTYPE html>
<html lang="uz">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Mening profilim - ShaharTaxi</title>
  <style>
    :root{
      --blue:#007bff;--green:#28a745;--red:#dc3545;--muted:#666;
      --card:#fff;--bg:#f7f9fc;
    }
    body{font-family:Arial,Helvetica,sans-serif;background:var(--bg);margin:0;padding:0;color:#222;}
    header{background:var(--blue);color:#fff;padding:14px 16px;position:relative}
    header h1{margin:0;font-size:20px}
    .logout{position:absolute;right:14px;top:10px;background:var(--red);border:none;padding:8px 12px;border-radius:6px;color:#fff;cursor:pointer}
    .container{max-width:980px;margin:18px auto;padding:16px;background:var(--card);border-radius:10px;box-shadow:0 6px 18px rgba(0,0,0,0.06)}
    h2{color:var(--blue);margin:6px 0 12px 0;text-align:center}
    .filters{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:8px;margin-bottom:12px}
    select,input,textarea{width:100%;padding:8px;border-radius:6px;border:1px solid #ccc;font-size:14px;box-sizing:border-box}
    button{background:var(--blue);color:#fff;border:none;padding:8px 12px;border-radius:8px;cursor:pointer}
    button.secondary{background:#6c757d}
    .ad-box{padding:12px;border-radius:8px;border:1px solid #e6eefc;margin-bottom:10px;background:#fff}
    .ad-box.pending{background:#fbfbfb}
    .ad-box.approved{background:#e9fff0}
    .ad-box.rejected{background:#fff0f0}
    .actions{margin-top:10px;display:flex;gap:8px;flex-wrap:wrap}
    .inline-edit{display:flex;gap:8px;align-items:center;margin-top:8px}
    .inline-edit input{padding:6px;border-radius:6px;border:1px solid #ccc}
    .date-info{font-size:12px;color:var(--muted);font-style:italic;margin-top:6px}
    .comment-box{background:#f8f9ff;padding:8px;border-left:4px solid var(--blue);border-radius:6px;margin-top:8px}
    .profile-header{display:flex;gap:16px;align-items:center;flex-wrap:wrap;margin-bottom:10px}
    .profile-card{padding:12px;border-radius:8px;background:#fff;border:1px solid #eee;flex:1;min-width:220px}
    .rating-summary{font-size:18px;font-weight:700;color:#111}
    .small{font-size:13px;color:var(--muted)}
    .view-profile-btn{background:#17a2b8}
    .center{text-align:center}
    .modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.45);align-items:center;justify-content:center;z-index:9999}
    .modal-content{background:#fff;padding:16px;border-radius:8px;width:360px;max-width:90%}
    .flex{display:flex;gap:8px}
    .pill{padding:6px 10px;border-radius:999px;background:#f1f3f5;border:1px solid #e6eefc}
    footer{margin:12px;text-align:center;color:var(--muted);font-size:13px}
    @media(max-width:720px){ .profile-header{flex-direction:column;align-items:stretch} }
  </style>
</head>
<body>
  <header>
    <h1>ShaharTaxi ‚Äî Profil</h1>
    <button class="logout" onclick="logout()">Chiqish</button>
  </header>

  <div class="container" id="mainContainer">
    <!-- PROFIL BOSHLANISH -->
    <div id="profileArea">
      <div class="profile-header">
        <div class="profile-card" id="profileInfoCard">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div>
              <div id="profileName" style="font-size:18px;font-weight:700">Foydalanuvchi</div>
              <div id="profilePhone" class="small">‚Äî</div>
            </div>
            <div class="center">
              <div id="profileRatingBig" class="rating-summary">‚Äî</div>
              <div class="small" id="profileRatingCount">‚Äî</div>
            </div>
          </div>
          <div style="margin-top:8px">
            <button onclick="openEditProfile()" id="editProfileBtn" class="secondary">Profilni tahrirlash</button>
            <button onclick="viewOwnAds()" style="margin-left:8px">Mening e'lonlarim</button>
          </div>
        </div>

        <div style="flex:1;min-width:300px;">
          <div style="display:flex;gap:8px;align-items:center;">
            <div style="flex:1">
              <input id="searchAdInput" placeholder="E'lon qidirish (ID yoki telefon)..." oninput="renderAdsList()" />
            </div>
            <div style="width:120px"><select id="filterType" onchange="renderAdsList()"><option value="all">Barchasi</option><option value="driver">Haydovchi</option><option value="passenger">Yo‚Äòlovchi</option></select></div>
            <div style="width:140px"><select id="filterStatus" onchange="renderAdsList()"><option value="all">Barchasi</option><option value="pending">Kutilmoqda</option><option value="approved">Tasdiqlangan</option><option value="rejected">Rad etilgan</option></select></div>
          </div>

          <div style="margin-top:8px;display:flex;gap:8px;align-items:center">
            <div style="flex:1">
              <select id="filterFromRegion" onchange="updateFilterDistricts('filterFrom')">
                <option value="">Qayerdan (viloyat)</option>
              </select>
            </div>
            <div style="flex:1">
              <select id="filterFromDistrict"><option value="">Qayerdan (tuman)</option></select>
            </div>
          </div>
          <div style="margin-top:8px;display:flex;gap:8px;align-items:center">
            <div style="flex:1">
              <select id="filterToRegion" onchange="updateFilterDistricts('filterTo')">
                <option value="">Qayerga (viloyat)</option>
              </select>
            </div>
            <div style="flex:1">
              <select id="filterToDistrict"><option value="">Qayerga (tuman)</option></select>
            </div>
          </div>
        </div>
      </div>

      <hr />

      <h2>Mening e‚Äôlonlarim</h2>

      <div id="myAds"></div>

      <hr />

      <h2>Yangi e‚Äôlon qo‚Äòshish</h2>
      <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:8px">
        <div><select id="adType"><option value="">E‚Äôlon turini tanlang</option><option value="driver">Haydovchi</option><option value="passenger">Yo‚Äòlovchi</option></select></div>
        <div><select id="fromRegion" onchange="updateDistricts('from')"></select></div>
        <div><select id="fromDistrict"></select></div>
        <div><select id="toRegion" onchange="updateDistricts('to')"></select></div>
        <div><select id="toDistrict"></select></div>
        <div><input id="price" type="number" placeholder="Narx (so'm)" /></div>
      </div>
      <div style="margin-top:8px">
        <textarea id="adComment" rows="3" placeholder="Qo‚Äòshimcha izoh (ixtiyoriy)"></textarea>
      </div>
      <div style="margin-top:8px;display:flex;gap:8px;align-items:center">
        <button onclick="addAd()">E‚Äôlonni joylash</button>
        <button class="secondary" onclick="clearAddForm()">Tozalash</button>
        <div style="margin-left:auto" class="small">‚ö†Ô∏è E‚Äôlon joylanganda admin tasdiqlashini kutadi</div>
      </div>

      <!-- PROFILE VIEW (when viewing other user) -->
      <div id="viewProfileModal" class="modal">
        <div class="modal-content">
          <h3 id="vpName">Profil</h3>
          <div id="vpPhone" class="small"></div>
          <div style="margin-top:8px" id="vpRatingSummary"></div>
          <div style="margin-top:8px"><strong>Foydalanuvchi e'lonlari:</strong></div>
          <div id="vpAdsList" style="max-height:240px;overflow:auto;margin-top:6px"></div>
          <div style="margin-top:8px" id="vpRateSection"></div>
          <div style="margin-top:12px;text-align:right"><button onclick="closeViewProfile()">Yopish</button></div>
        </div>
      </div>

    </div> <!-- profileArea -->
  </div>

  <footer>ShaharTaxi ‚Äî lokal demo ¬∑ ma'lumot localStorage da saqlanadi</footer>

  <!-- ===== Modal: Edit Profile ===== -->
  <div id="editProfileModal" class="modal"><div class="modal-content">
    <h3>Profilni tahrirlash</h3>
    <div><input id="editFullName" placeholder="Ism/Foydalanuvchi nomi"/></div>
    <div style="margin-top:8px"><input id="editPhoneInput" placeholder="Telefon raqam"/></div>
    <div style="margin-top:10px;text-align:right">
      <button onclick="saveProfileEdit()">Saqlash</button>
      <button class="secondary" onclick="closeEditProfile()">Bekor</button>
    </div>
  </div></div>

<script>
/*
  To'liq ishlaydigan profile.html
  - Saqlovchi kalitlar: driverAds, passengerAds, currentUser, users, userNotifications, profileRatings
  - View other user's profile: "Profilni ko'rish" (har bir e'lon qatori uchun qo'shing)
  - Rating: faqat boshqa foydalanuvchilar baholaydi; takroriy baho qoldirib bo'lmaydi (variant: o'zgartirish ruxsatini qo'yish mumkin)
  - Regions: ichida objects (agar sizning regions.js bo'lsa uni o'zgartirish shart emas)
*/

/* -----------------------
   MOCK: agar sizda avval login tizimi bo'lmasa, test uchun chaqiring:
   loginMock(); // bu funksiya test maqsadida currentUser va users yaratadi
   ----------------------- */

/* ---------- REGIONS DATA (ichida) ---------- */
const regions = {
  "Toshkent": ["Bektemir","Chilonzor","Mirzo Ulug'bek","Mirobod"],
  "Samarqand": ["Bulungur","Ishtixon","Urgut","Kattaqo'rg'on"],
  "Namangan": ["Pop","Chust","To'raqo'rg'on"],
  "Andijon": ["Asaka","Andijon sh.","Marhamat"],
  "Farg'ona": ["Qo'qon","Qo'rg'ontepa","Beshariq"],
  "Buxoro": ["Buxoro sh.","G'ijduvon","Jondor"],
  "Xorazm": ["Urgench","Xiva","Shovot"],
  "Qashqadaryo": ["Qarshi","G'uzor","Kitob"]
};

/* ---------- Helpers: storage wrappers ---------- */
function getJSON(key){ try{ return JSON.parse(localStorage.getItem(key)) || []; } catch(e){ return []; } }
function setJSON(key,val){ localStorage.setItem(key, JSON.stringify(val)); }

/* ---------- Current user detection ---------- */
// we support currentUser stored as object under 'currentUser' or fallback to 'activeUserId' in users list
function getCurrentUser(){
  const cu = JSON.parse(localStorage.getItem('currentUser') || 'null');
  if(cu && cu.phone) return cu;
  // fallback: if users array exists and has active flag
  const users = getJSON('users') || [];
  const active = users.find(u=>u.active) || null;
  if(active) return active;
  return null;
}

/* Test helper: create a mock login user and sample ads if none exist (for development) */
function loginMock(){
  // create two users if not exist
  let users = getJSON('users');
  if(users.length === 0){
    users = [
      { id: 'u1', phone: '998901112233', name: 'Ali', active: true },
      { id: 'u2', phone: '998909998877', name: 'Vali', active: false },
      { id: 'u3', phone: '998971234567', name: 'Dilor', active: false }
    ];
    setJSON('users', users);
  }
  // set currentUser
  const currentUser = users[0];
  localStorage.setItem('currentUser', JSON.stringify(currentUser));

  // sample ads (only if empty)
  if(getJSON('driverAds').length === 0 && getJSON('passengerAds').length === 0){
    const now = new Date();
    const driverAds = [
      { id: 'driver_1', phone: users[0].phone, ownerId: users[0].id, type:'driver', fromRegion:'Toshkent', fromDistrict:'Chilonzor', toRegion:'Samarqand', toDistrict:'Ishtixon', price:'25000', comment:'Haydovchi 24/7', status:'approved', createdAt: new Date(now.getTime()-86400000*2).toLocaleString() },
      { id: 'driver_2', phone: users[1].phone, ownerId: users[1].id, type:'driver', fromRegion:'Toshkent', fromDistrict:'Mirzo Ulug\'bek', toRegion:'Namangan', toDistrict:'Pop', price:'80000', comment:'Katta yukga bo\'sh joy', status:'pending', createdAt: new Date(now.getTime()-86400000*10).toLocaleString() }
    ];
    const passengerAds = [
      { id: 'pass_1', phone: users[2].phone, ownerId: users[2].id, type:'passenger', fromRegion:'Samarqand', fromDistrict:'Urgut', toRegion:'Toshkent', toDistrict:'Bektemir', price:'30000', comment:'Iltimos tez', status:'rejected', createdAt: new Date(now.getTime()-86400000*1).toLocaleString() },
      { id: 'pass_2', phone: users[0].phone, ownerId: users[0].id, type:'passenger', fromRegion:'Namangan', fromDistrict:'To\'raqo\'rg\'on', toRegion:'Farg\'ona', toDistrict:'Qo\'qon', price:'20000', comment:'Yuk ham olaman', status:'pending', createdAt: new Date(now.getTime()-86400000*4).toLocaleString() }
    ];
    setJSON('driverAds', driverAds);
    setJSON('passengerAds', passengerAds);
  }
}

/* ---------- Utility: parse various date formats safely ---------- */
function parseAdDate(dateStr){
  if(!dateStr) return null;
  // if ISO or Date parseable
  const d = new Date(dateStr);
  if(!isNaN(d)) return d;
  // try dd.mm.yyyy hh:mm or dd.mm.yyyy
  const m = String(dateStr).match(/^(\d{2})\.(\d{2})\.(\d{4})(?:\s+(\d{2}):(\d{2}))?$/);
  if(m){
    const [_,day,mon,yr,h,mn] = m;
    return new Date(+yr, +mon-1, +day, + (h||0), + (mn||0));
  }
  return null;
}

/* ---------- Ensure comments & ownerId exist on old ads ---------- */
function normalizeOldAds(){
  ['driverAds','passengerAds'].forEach(key=>{
    const ads = getJSON(key);
    let changed=false;
    ads.forEach(a=>{
      if(!('comment' in a)){ a.comment = ''; changed=true; }
      if(!a.ownerId && a.phone){
        // try to map to user id by phone
        const users = getJSON('users') || [];
        const u = users.find(x=>String(x.phone)===String(a.phone));
        if(u){ a.ownerId = u.id; changed=true; }
      }
      if(!a.createdAt){
        // give fallback
        a.createdAt = new Date().toLocaleString();
        changed=true;
      }
    });
    if(changed) setJSON(key, ads);
  });
}

/* ---------- RENDER functions ---------- */
function renderProfileHeader(profileUser){
  // profileUser: {id, phone, name}
  document.getElementById('profileName').textContent = profileUser.name || 'Foydalanuvchi';
  document.getElementById('profilePhone').textContent = profileUser.phone || '‚Äî';
  // rating summary
  const ratings = getRatingsForProfile(profileUser.id || profileUser.phone);
  const avg = computeAverage(ratings);
  document.getElementById('profileRatingBig').textContent = avg>0 ? `${avg} / 5` : '‚Äî';
  document.getElementById('profileRatingCount').textContent = ratings.length ? `${ratings.length} ta baho` : 'Hozircha baholar yo‚Äòq';
  // show/hide edit button
  const cu = getCurrentUser();
  const editBtn = document.getElementById('editProfileBtn');
  if(cu && (String(cu.id) === String(profileUser.id) || String(cu.phone) === String(profileUser.phone))){
    editBtn.style.display = 'inline-block';
  } else {
    editBtn.style.display = 'none';
  }
}

function renderAdsList(){
  // render ads (all ads of the current viewed profile if set, else user's own ads)
  normalizeOldAds();
  const cu = getCurrentUser();
  const viewingProfile = window.viewingProfile || (cu? (cu.id||cu.phone) : null);

  // gather filters
  const q = (document.getElementById('searchAdInput').value || '').toLowerCase().trim();
  const typeFilter = document.getElementById('filterType').value;
  const statusFilter = document.getElementById('filterStatus').value;
  const fFromRegion = document.getElementById('filterFromRegion').value;
  const fFromDistrict = document.getElementById('filterFromDistrict').value;
  const fToRegion = document.getElementById('filterToRegion').value;
  const fToDistrict = document.getElementById('filterToDistrict').value;

  const driver = getJSON('driverAds') || [];
  const passenger = getJSON('passengerAds') || [];
  let all = [...driver.map(a=>({...a,type:'driver'})), ...passenger.map(a=>({...a,type:'passenger'}))];

  // if viewingProfile specified, show only those user's ads
  if(viewingProfile){
    all = all.filter(a => String(a.ownerId || a.phone) === String(viewingProfile) || String(a.phone) === String(viewingProfile));
  } else {
    // default: currentUser
    const cu2 = getCurrentUser();
    if(cu2) all = all.filter(a => String(a.phone) === String(cu2.phone) || String(a.ownerId) === String(cu2.id));
  }

  // filters
  if(typeFilter !== 'all') all = all.filter(a => a.type === typeFilter);
  if(statusFilter !== 'all') all = all.filter(a => (a.status||'pending') === statusFilter);
  if(fFromRegion) all = all.filter(a => (a.fromRegion || '').includes(fFromRegion));
  if(fFromDistrict) all = all.filter(a => (a.fromDistrict || '').includes(fFromDistrict));
  if(fToRegion) all = all.filter(a => (a.toRegion || '').includes(fToRegion));
  if(fToDistrict) all = all.filter(a => (a.toDistrict || '').includes(fToDistrict));
  if(q) all = all.filter(a => (String(a.phone||'')+String(a.id||'')+String(a.comment||'')).toLowerCase().includes(q));

  // sort by date desc
  all.sort((a,b)=>{
    const da = parseAdDate(a.createdAt) || new Date(0);
    const db = parseAdDate(b.createdAt) || new Date(0);
    return db - da;
  });

  // render
  const container = document.getElementById('myAds');
  container.innerHTML = '';
  if(all.length === 0){
    container.innerHTML = '<p>Hozircha e‚Äôlonlar yo‚Äòq.</p>';
    return;
  }

  all.forEach(ad=>{
    const div = document.createElement('div');
    div.className = 'ad-box ' + ((ad.status && ad.status.toLowerCase()) || 'pending');

    const from = (ad.fromRegion? ad.fromRegion+' ':'') + (ad.fromDistrict? ad.fromDistrict:'');
    const to = (ad.toRegion? ad.toRegion+' ':'') + (ad.toDistrict? ad.toDistrict:'');
    const created = ad.createdAt ? (parseAdDate(ad.createdAt) ? parseAdDate(ad.createdAt).toLocaleString() : ad.createdAt) : '‚Äî';
    const statusText = ad.status === 'approved' ? '‚úÖ Tasdiqlangan' : ad.status === 'rejected' ? '‚ùå Rad etilgan' : '‚è≥ Kutilmoqda';
    const ownerId = ad.ownerId || ad.phone;

    // profile view button (for others profiles)
    const profileBtn = `<button class="view-profile-btn" onclick="openViewProfile('${ownerId}')">üîé Profilni ko'rish</button>`;

    // inline edit if owner current user and not approved (we keep both flows)
    let actionsHTML = '';
    const cu2 = getCurrentUser();
    const isOwner = cu2 && (String(cu2.phone) === String(ad.phone) || String(cu2.id) === String(ad.ownerId));
    if(isOwner){
      if(ad.status !== 'approved'){
        actionsHTML += `<button onclick="startInlineEdit('${ad.type}','${ad.id}')">Inline tahrir</button>`;
        actionsHTML += `<button onclick="editAd('${ad.id}','${ad.type}')">‚úèÔ∏è Tahrirlash</button>`;
      } else {
        actionsHTML += `<button disabled style="background:#ccc;cursor:not-allowed;">‚úèÔ∏è Tahrirlash</button>`;
      }
      actionsHTML += `<button onclick="deleteAd('${ad.id}','${ad.type}')">üóëÔ∏è O'chirish</button>`;
    } else {
      // not owner: show contact / profile
      actionsHTML += profileBtn;
      actionsHTML += `<button onclick="contactOwner('${ad.phone}')">üìû Telefon</button>`;
    }

    // show comment-box if present
    const commentHTML = ad.comment ? `<div class="comment-box"><b>Izoh:</b> ${escapeHtml(ad.comment)}</div>` : '';

    div.innerHTML = `
      <div><b>Yo'nalish:</b> ${escapeHtml(from)} ‚Üí ${escapeHtml(to)}</div>
      <div><b>Narx:</b> ${escapeHtml(ad.price || 'Ko‚Äòrsatilmagan')} so'm</div>
      <div><b>Telefon:</b> ${escapeHtml(ad.phone || 'Noma\'lum')}</div>
      <div class="date-info">üïí Joylangan: ${escapeHtml(created)} ¬∑ Holat: ${escapeHtml(statusText)}</div>
      ${commentHTML}
      <div class="actions">${actionsHTML}</div>
    `;

    container.appendChild(div);
  });
}

/* ---------- Add Ad ---------- */
function addAd(){
  const cu = getCurrentUser();
  if(!cu){ alert('Avval tizimga kiring!'); return; }
  const type = document.getElementById('adType').value;
  const fromRegion = document.getElementById('fromRegion').value.trim();
  const fromDistrict = document.getElementById('fromDistrict').value.trim();
  const toRegion = document.getElementById('toRegion').value.trim();
  const toDistrict = document.getElementById('toDistrict').value.trim();
  const price = document.getElementById('price').value.trim();
  const comment = document.getElementById('adComment').value.trim();

  if(!type || !fromRegion || !toRegion){
    alert('Iltimos yo‚Äònalish ma\'lumotlarini to‚Äòldiring!');
    return;
  }

  const key = type === 'driver' ? 'driverAds' : 'passengerAds';
  const ads = getJSON(key);
  const id = `${type}_${Date.now()}_${Math.floor(Math.random()*1000)}`;
  const newAd = {
    id,
    phone: cu.phone,
    ownerId: cu.id || cu.phone,
    type,
    fromRegion, fromDistrict, toRegion, toDistrict,
    price, comment: comment || '',
    status: 'pending',
    createdAt: new Date().toLocaleString()
  };
  ads.push(newAd);
  setJSON(key, ads);

  // update stats and UI
  renderAdsList();
  alert('‚úÖ E‚Äôlon joylandi (Admin tasdiqlashi kutilmoqda).');
  clearAddForm();
}

/* ---------- Edit Ad (prompt) ---------- */
function editAd(id,type){
  const key = type === 'driver' ? 'driverAds' : 'passengerAds';
  const ads = getJSON(key);
  const ad = ads.find(a=>String(a.id) === String(id));
  if(!ad) return;
  if(ad.edited){ alert('‚ùó Ushbu e\'lon avval tahrirlangan.'); return; }
  const newPrice = prompt('Yangi narxni kiriting:', ad.price || '');
  if(newPrice === null) return;
  ad.price = newPrice;
  ad.edited = true;
  setJSON(key, ads);
  renderAdsList();
  alert('‚úèÔ∏è E\'lon yangilandi.');
}

/* ---------- Inline edit (admin/user inline) ---------- */
function startInlineEdit(type,id){
  // find actions area for the ad in DOM and replace with inline form
  // We'll re-render the whole list with an inline editing state stored in localStorage.tempInline
  const temp = { type, id };
  localStorage.setItem('tempInlineEdit', JSON.stringify(temp));
  renderAdsListWithInline();
}

function renderAdsListWithInline(){
  // essentially same as renderAdsList but when tempInline present show inputs
  normalizeOldAds();
  const temp = JSON.parse(localStorage.getItem('tempInlineEdit') || 'null');
  // reuse renderAdsList but with slight tweak ‚Äî simpler to reimplement loop here
  const cu = getCurrentUser();
  const viewingProfile = window.viewingProfile || (cu? (cu.id||cu.phone) : null);

  const q = (document.getElementById('searchAdInput').value || '').toLowerCase().trim();
  const typeFilter = document.getElementById('filterType').value;
  const statusFilter = document.getElementById('filterStatus').value;
  const fFromRegion = document.getElementById('filterFromRegion').value;
  const fFromDistrict = document.getElementById('filterFromDistrict').value;
  const fToRegion = document.getElementById('filterToRegion').value;
  const fToDistrict = document.getElementById('filterToDistrict').value;

  const driver = getJSON('driverAds') || [];
  const passenger = getJSON('passengerAds') || [];
  let all = [...driver.map(a=>({...a,type:'driver'})), ...passenger.map(a=>({...a,type:'passenger'}))];

  if(viewingProfile){
    all = all.filter(a => String(a.ownerId || a.phone) === String(viewingProfile) || String(a.phone) === String(viewingProfile));
  } else {
    const cu2 = getCurrentUser();
    if(cu2) all = all.filter(a => String(a.phone) === String(cu2.phone) || String(a.ownerId) === String(cu2.id));
  }

  if(typeFilter !== 'all') all = all.filter(a => a.type === typeFilter);
  if(statusFilter !== 'all') all = all.filter(a => (a.status||'pending') === statusFilter);
  if(fFromRegion) all = all.filter(a => (a.fromRegion || '').includes(fFromRegion));
  if(fFromDistrict) all = all.filter(a => (a.fromDistrict || '').includes(fFromDistrict));
  if(fToRegion) all = all.filter(a => (a.toRegion || '').includes(fToRegion));
  if(fToDistrict) all = all.filter(a => (a.toDistrict || '').includes(fToDistrict));
  if(q) all = all.filter(a => (String(a.phone||'')+String(a.id||'')+String(a.comment||'')).toLowerCase().includes(q));

  all.sort((a,b)=>{
    const da = parseAdDate(a.createdAt) || new Date(0);
    const db = parseAdDate(b.createdAt) || new Date(0);
    return db - da;
  });

  const container = document.getElementById('myAds');
  container.innerHTML = '';
  if(all.length === 0){ container.innerHTML = '<p>Hozircha e‚Äôlonlar yo‚Äòq.</p>'; return; }

  all.forEach(ad=>{
    const div = document.createElement('div');
    div.className = 'ad-box ' + ((ad.status && ad.status.toLowerCase()) || 'pending');
    const from = (ad.fromRegion? ad.fromRegion+' ':'') + (ad.fromDistrict? ad.fromDistrict:'');
    const to = (ad.toRegion? ad.toRegion+' ':'') + (ad.toDistrict? ad.toDistrict:'');
    const created = ad.createdAt ? (parseAdDate(ad.createdAt) ? parseAdDate(ad.createdAt).toLocaleString() : ad.createdAt) : '‚Äî';
    const statusText = ad.status === 'approved' ? '‚úÖ Tasdiqlangan' : ad.status === 'rejected' ? '‚ùå Rad etilgan' : '‚è≥ Kutilmoqda';
    const ownerId = ad.ownerId || ad.phone;
    const cu2 = getCurrentUser();
    const isOwner = cu2 && (String(cu2.phone) === String(ad.phone) || String(cu2.id) === String(ad.ownerId));

    let actionsHTML = '';
    if(isOwner){
      if(temp && temp.type === ad.type && String(temp.id) === String(ad.id)){
        // show inline form
        actionsHTML = `
          <div class="inline-edit">
            <input id="inlinePrice_${ad.id}" type="number" placeholder="Narx" value="${escapeHtml(ad.price || '')}" />
            <button onclick="saveInlineAdmin('${ad.type}','${ad.id}')">üíæ Saqlash</button>
            <button onclick="cancelInlineAdmin()">‚ùå Bekor</button>
          </div>
        `;
      } else {
        if(ad.status !== 'approved'){
          actionsHTML += `<button onclick="startInlineEdit('${ad.type}','${ad.id}')">Inline tahrir</button>`;
          actionsHTML += `<button onclick="editAd('${ad.id}','${ad.type}')">‚úèÔ∏è Tahrirlash</button>`;
        } else {
          actionsHTML += `<button disabled style="background:#ccc;cursor:not-allowed;">‚úèÔ∏è Tahrirlash</button>`;
        }
        actionsHTML += `<button onclick="deleteAd('${ad.id}','${ad.type}')">üóëÔ∏è O'chirish</button>`;
      }
    } else {
      actionsHTML += `<button class="view-profile-btn" onclick="openViewProfile('${ownerId}')">üîé Profilni ko'rish</button>`;
      actionsHTML += `<button onclick="contactOwner('${ad.phone}')">üìû Telefon</button>`;
    }

    const commentHTML = ad.comment ? `<div class="comment-box"><b>Izoh:</b> ${escapeHtml(ad.comment)}</div>` : '';
    div.innerHTML = `
      <div><b>Yo'nalish:</b> ${escapeHtml(from)} ‚Üí ${escapeHtml(to)}</div>
      <div><b>Narx:</b> ${escapeHtml(ad.price || 'Ko‚Äòrsatilmagan')} so'm</div>
      <div><b>Telefon:</b> ${escapeHtml(ad.phone || 'Noma\'lum')}</div>
      <div class="date-info">üïí Joylangan: ${escapeHtml(created)} ¬∑ Holat: ${escapeHtml(statusText)}</div>
      ${commentHTML}
      <div class="actions">${actionsHTML}</div>
    `;
    container.appendChild(div);
  });
}

/* ---------- Save inline admin/user edit ---------- */
function saveInlineAdmin(type,id){
  const key = type === 'driver' ? 'driverAds' : 'passengerAds';
  const ads = getJSON(key);
  const ad = ads.find(a=>String(a.id) === String(id));
  if(!ad) return;
  const val = document.getElementById(`inlinePrice_${id}`).value.trim();
  if(!val){ alert('Narx kiriting'); return; }
  ad.price = val;
  ad.edited = true;
  setJSON(key, ads);
  localStorage.removeItem('tempInlineEdit');
  renderAdsList();
  alert('E\'lon yangilandi (inline).');
}
function cancelInlineAdmin(){
  localStorage.removeItem('tempInlineEdit');
  renderAdsList();
}

/* ---------- Delete Ad ---------- */
function deleteAd(id,type){
  if(!confirm('Haqiqatan o\'chirilsinmi?')) return;
  const key = type === 'driver' ? 'driverAds' : 'passengerAds';
  let ads = getJSON(key);
  ads = ads.filter(a => String(a.id) !== String(id));
  setJSON(key, ads);
  renderAdsList();
}

/* ---------- Contact owner (simple) ---------- */
function contactOwner(phone){
  if(!phone){ alert('Telefon raqam mavjud emas'); return; }
  alert(`Telefon: ${phone} (telefonni nusxa oling yoki qo'ng'iroq qiling)`);
}

/* ---------- Clear add form ---------- */
function clearAddForm(){
  document.getElementById('adType').value = '';
  document.getElementById('fromRegion').value = '';
  document.getElementById('fromDistrict').innerHTML = '<option value="">Tumanni tanlang</option>';
  document.getElementById('toRegion').value = '';
  document.getElementById('toDistrict').innerHTML = '<option value="">Tumanni tanlang</option>';
  document.getElementById('price').value = '';
  document.getElementById('adComment').value = '';
}

/* ---------- Filters: populate regions/district selects ---------- */
function loadRegionsToSelects(){
  ['fromRegion','toRegion','filterFromRegion','filterToRegion'].forEach(id=>{
    const sel = document.getElementById(id);
    if(!sel) return;
    sel.innerHTML = '<option value="">Viloyatni tanlang</option>';
    Object.keys(regions).forEach(r=>{
      const opt = document.createElement('option'); opt.value = r; opt.textContent = r;
      sel.appendChild(opt);
    });
  });
}
function updateDistricts(prefix){
  const region = document.getElementById(prefix+'Region').value;
  const districtSel = document.getElementById(prefix+'District');
  districtSel.innerHTML = '<option value="">Tumanni tanlang</option>';
  if(region && regions[region]){
    regions[region].forEach(d => {
      const opt = document.createElement('option'); opt.value = d; opt.textContent = d;
      districtSel.appendChild(opt);
    });
  }
}
function updateFilterDistricts(prefix){
  const region = document.getElementById(prefix+'Region').value;
  const districtSel = document.getElementById(prefix+'District');
  districtSel.innerHTML = '<option value="">Tanlang</option>';
  if(region && regions[region]){
    regions[region].forEach(d => districtSel.add(new Option(d,d)));
  }
  renderAdsList();
}

/* ---------- Profile viewing modal & rating ---------- */
function openViewProfile(idOrPhone){
  // resolve user by id or phone
  const users = getJSON('users') || [];
  let user = users.find(u => String(u.id) === String(idOrPhone) || String(u.phone) === String(idOrPhone));
  // fallback: create a lightweight object from ads if no users entry
  if(!user){
    // look up in ads
    const ads = [...getJSON('driverAds'), ...getJSON('passengerAds')];
    const ad = ads.find(a => String(a.ownerId) === String(idOrPhone) || String(a.phone) === String(idOrPhone));
    if(ad) user = { id: ad.ownerId || ad.phone, phone: ad.phone, name: ad.ownerName || ad.phone };
  }
  if(!user){ alert('Foydalanuvchi topilmadi'); return; }
  window.viewingProfile = user.id || user.phone;

  // render modal content: header and their ads
  document.getElementById('vpName').textContent = user.name || 'Foydalanuvchi';
  document.getElementById('vpPhone').textContent = user.phone || '‚Äî';

  // rating summary
  const ratings = getRatingsForProfile(user.id || user.phone);
  const avg = computeAverage(ratings);
  document.getElementById('vpRatingSummary').innerHTML = `<strong>${avg>0 ? avg+' / 5' : 'Hozircha baho yo‚Äòq'}</strong> ‚Äî ${ratings.length} ta baho`;

  // list ads of that user
  const vpAds = [...getJSON('driverAds'), ...getJSON('passengerAds')].filter(a => String(a.ownerId) === String(user.id) || String(a.phone) === String(user.phone));
  const vpList = document.getElementById('vpAdsList');
  if(vpAds.length === 0) vpList.innerHTML = '<p class="small">Ushbu foydalanuvchining e\'lonlari mavjud emas.</p>';
  else {
    vpList.innerHTML = vpAds.map(a => {
      const created = a.createdAt? (parseAdDate(a.createdAt)? parseAdDate(a.createdAt).toLocaleString() : a.createdAt) : '';
      return `<div style="padding:6px;border-bottom:1px solid #eee;"><b>${a.type === 'driver'? 'Haydovchi' : 'Yo\'lovchi'}</b> ¬∑ ${escapeHtml(a.fromRegion||'')} ‚Üí ${escapeHtml(a.toRegion||'')} ¬∑ ${escapeHtml(a.price||'')} so'm<br><small class="small">${escapeHtml(created)}</small></div>`;
    }).join('');
  }

  // rating input area: only if currentUser logged and not owner and not rated yet
  const cur = getCurrentUser();
  const vpRateSection = document.getElementById('vpRateSection');
  vpRateSection.innerHTML = '';
  if(!cur){
    vpRateSection.innerHTML = '<div class="small">Baholash uchun avval tizimga kiring.</div>';
  } else if(String(cur.id) === String(user.id) || String(cur.phone) === String(user.phone)){
    vpRateSection.innerHTML = '<div class="small">Siz o\'zingizni baholay olmaysiz.</div>';
  } else {
    const ratingsStore = getProfileRatingsStore();
    const existing = (ratingsStore.find(e=>String(e.phone)===String(user.id)) || {ratings:[]}).ratings || [];
    const already = existing.some(r=>String(r.raterPhone)===String(cur.phone));
    if(already){
      vpRateSection.innerHTML = '<div class="small">Siz allaqachon bu foydalanuvchini baholagansiz.</div>';
    } else {
      vpRateSection.innerHTML = `
        <div style="margin-top:8px;">
          <label><b>‚≠ê Baho tanlang</b></label>
          <div style="margin-top:6px;">
            <select id="vpRatingStars">
              <option value="5">5</option><option value="4">4</option><option value="3">3</option><option value="2">2</option><option value="1">1</option>
            </select>
          </div>
          <div style="margin-top:6px;"><textarea id="vpRatingText" rows="2" placeholder="Ixtiyoriy izoh..."></textarea></div>
          <div style="margin-top:8px;text-align:right;"><button onclick="submitProfileRating('${user.id||user.phone}')">Yuborish</button></div>
        </div>
      `;
    }
  }

  document.getElementById('viewProfileModal').style.display = 'flex';
}

function closeViewProfile(){
  document.getElementById('viewProfileModal').style.display = 'none';
  // remove viewingProfile
  // keep it so render functions can use it until changed
}

/* ---------- PROFILE RATING STORE (simple) ---------- */
function getProfileRatingsStore(){ return JSON.parse(localStorage.getItem('profileRatings') || '[]'); }
function saveProfileRatingsStore(store){ localStorage.setItem('profileRatings', JSON.stringify(store)); }
function getRatingsForProfile(profileId){
  if(!profileId) return [];
  const store = getProfileRatingsStore();
  const e = store.find(it=>String(it.phone)===String(profileId));
  return e? e.ratings : [];
}
function addRatingForProfile(profileId, rating){
  const store = getProfileRatingsStore();
  let entry = store.find(it=>String(it.phone)===String(profileId));
  if(!entry){ entry = { phone: String(profileId), ratings: [] }; store.push(entry); }
  entry.ratings.push(rating);
  saveProfileRatingsStore(store);
}
function computeAverage(ratings){
  if(!ratings || ratings.length === 0) return 0;
  const s = ratings.reduce((sum,r)=> sum + (Number(r.stars)||0), 0);
  return +(s / ratings.length).toFixed(2);
}

/* ---------- Submit profile rating ---------- */
function submitProfileRating(profileId){
  const cur = getCurrentUser();
  if(!cur){ alert('Baholash uchun tizimga kiring!'); return; }
  const stars = Number(document.getElementById('vpRatingStars').value) || 5;
  const text = (document.getElementById('vpRatingText').value || '').trim();
  // avoid duplicate
  const existing = getRatingsForProfile(profileId);
  if(existing.some(r=>String(r.raterPhone) === String(cur.phone))){ alert('Siz allaqachon baho berdingiz'); return; }
  const r = { raterPhone: cur.phone, stars, text, date: new Date().toLocaleString() };
  addRatingForProfile(profileId, r);
  alert('‚úÖ Baho saqlandi!');
  // re-render profile modal & header
  if(window.viewingProfile) openViewProfile(window.viewingProfile);
  // if viewing own profile update header
  renderProfileHeader({ id: profileId, phone: profileId, name: '' });
}

/* ---------- Profile edit ---------- */
function openEditProfile(){
  const cu = getCurrentUser();
  if(!cu){ alert('Tizimga kiring!'); return; }
  document.getElementById('editFullName').value = cu.name || '';
  document.getElementById('editPhoneInput').value = cu.phone || '';
  document.getElementById('editProfileModal').style.display = 'flex';
}
function closeEditProfile(){ document.getElementById('editProfileModal').style.display = 'none'; }
function saveProfileEdit(){
  const name = document.getElementById('editFullName').value.trim();
  const phone = document.getElementById('editPhoneInput').value.trim();
  if(!phone){ alert('Telefon raqam kiriting'); return; }
  let users = getJSON('users') || [];
  const cur = getCurrentUser();
  if(cur){
    // update currentUser stored object
    cur.name = name; cur.phone = phone;
    localStorage.setItem('currentUser', JSON.stringify(cur));
    // update in users array if exists by id or phone match
    let uidx = users.findIndex(u => String(u.id) === String(cur.id) || String(u.phone) === String(cur.phone));
    if(uidx > -1){
      users[uidx].name = name; users[uidx].phone = phone;
    } else {
      // add user record
      const newid = cur.id || `u_${Date.now()}`;
      users.push({ id: newid, phone, name, active:true });
      cur.id = newid;
      localStorage.setItem('currentUser', JSON.stringify(cur));
    }
    setJSON('users', users);
    alert('Profil saqlandi');
    renderProfileHeader(cur);
    renderAdsList();
  } else {
    alert('Foydalanuvchi topilmadi');
  }
  closeEditProfile();
}

/* ---------- View own ads convenience ---------- */
function viewOwnAds(){
  const cu = getCurrentUser();
  if(!cu) return;
  window.viewingProfile = cu.id || cu.phone;
  renderAdsList();
}

/* ---------- Sync statuses (notify when admin changes) ---------- */
function syncStatuses(){
  const cu = getCurrentUser();
  if(!cu) return;
  const driver = getJSON('driverAds') || [];
  const passenger = getJSON('passengerAds') || [];
  const userAds = [...driver, ...passenger].filter(a => String(a.ownerId) === String(cu.id) || String(a.phone) === String(cu.phone));
  const lastStatuses = JSON.parse(localStorage.getItem('userAdStatuses') || '{}');
  userAds.forEach(ad=>{
    const prev = lastStatuses[ad.id];
    if(prev && prev !== ad.status){
      if(ad.status === 'approved') alert(`‚úÖ E'loningiz tasdiqlandi: ${ad.fromRegion || ad.from} ‚Üí ${ad.toRegion || ad.to}`);
      else if(ad.status === 'rejected') alert(`‚ùå E'loningiz rad etildi: ${ad.fromRegion || ad.from} ‚Üí ${ad.toRegion || ad.to}`);
    }
    lastStatuses[ad.id] = ad.status;
  });
  localStorage.setItem('userAdStatuses', JSON.stringify(lastStatuses));
}

/* ---------- Small helpers ---------- */
function escapeHtml(str){
  if(!str) return '';
  return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#039;');
}

/* ---------- Rating init on page load for header ---------- */
function initProfileOnLoad(){
  // ensure old ads normalized
  normalizeOldAds();
  // populate region selects
  loadRegionsToSelects();
  // pick profile to show:
  const maybeProfile = window.profilePhone || localStorage.getItem('viewingProfile') || null;
  let profileUser = null;
  if(maybeProfile){
    // find by id or phone in users or ads
    const users = getJSON('users') || [];
    profileUser = users.find(u=>String(u.id)===String(maybeProfile) || String(u.phone)===String(maybeProfile));
    if(!profileUser){
      const ads = [...getJSON('driverAds'), ...getJSON('passengerAds')];
      const ad = ads.find(a => String(a.ownerId)===String(maybeProfile) || String(a.phone)===String(maybeProfile));
      if(ad) profileUser = { id: ad.ownerId||ad.phone, phone: ad.phone, name: ad.ownerName || ad.phone };
    }
  }
  // fallback to current user
  const cu = getCurrentUser();
  if(!profileUser && cu) profileUser = cu;
  if(!profileUser){
    // still none -> prompt to login (or create mock)
    // for safety we don't auto-create users; but we can show empty UI.
    document.getElementById('profileName').textContent = 'Tizimga kiring';
    document.getElementById('profilePhone').textContent = '‚Äî';
  } else {
    renderProfileHeader(profileUser);
    window.viewingProfile = profileUser.id || profileUser.phone;
  }
  // render ads list for that profile
  renderAdsList();

  // start periodic sync
  setInterval(syncStatuses, 5000);
}

/* ---------- Public functions used by other parts ---------- */
function logout(){
  localStorage.removeItem('currentUser');
  // optionally clear viewingProfile
  // localStorage.removeItem('viewingProfile');
  alert('Chiqdingiz.');
  location.reload();
}

/* ---------- Profile modal helpers ---------- */
function closeViewProfile(){ document.getElementById('viewProfileModal').style.display = 'none'; }

/* ---------- When page loads ---------- */
document.addEventListener('DOMContentLoaded', ()=>{
  // If no currentUser found, you can call loginMock() manually for testing.
  // loginMock(); // <-- uncomment for quick local testing (creates users and sample ads)

  // If currentUser not present but there is 'activeUserId' use it to set currentUser from users list
  const activeId = localStorage.getItem('activeUserId');
  if(!localStorage.getItem('currentUser') && activeId){
    const users = getJSON('users') || [];
    const u = users.find(x=> String(x.id) === String(activeId));
    if(u) localStorage.setItem('currentUser', JSON.stringify(u));
  }

  loadRegionsToSelects();
  // if user provided window.profilePhone before, prefer that
  initProfileOnLoad();

  // click outside modal to close
  document.querySelectorAll('.modal').forEach(m=>{
    m.addEventListener('click', e=>{
      if(e.target === m) m.style.display = 'none';
    });
  });
});

/* ---------- Expose some functions to console for debugging ---------- */
window._debug = {
  getDriverAds: ()=>getJSON('driverAds'),
  getPassengerAds: ()=>getJSON('passengerAds'),
  getUsers: ()=>getJSON('users'),
  getRatings: ()=>getProfileRatingsStore(),
  loginMock
};
</script>
</body>
</html>
