<!DOCTYPE html>
<html lang="uz">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Profil ‚Äì ShaharTaxi</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f5f6fa;
      margin: 0;
      padding: 0;
    }

    .profile-container {
      max-width: 800px;
      margin: 40px auto;
      background: white;
      border-radius: 12px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      padding: 20px;
    }

    h2 {
      text-align: center;
      color: #333;
    }

    .ad-card {
      border-radius: 10px;
      padding: 15px;
      margin-bottom: 15px;
      background: #fff;
      box-shadow: 0 1px 4px rgba(0,0,0,0.1);
      transition: background 0.3s ease;
    }

    .ad-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-weight: bold;
      margin-bottom: 5px;
    }

    .status {
      padding: 4px 8px;
      border-radius: 6px;
      font-size: 13px;
      color: #fff;
    }

    .ad-actions button {
      margin-right: 5px;
      border: none;
      background: #007bff;
      color: white;
      border-radius: 6px;
      padding: 6px 10px;
      cursor: pointer;
      transition: background 0.3s;
    }

    .ad-actions button:hover {
      background: #0056b3;
    }

    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      background: #28a745;
      color: white;
      padding: 10px 20px;
      border-radius: 8px;
      box-shadow: 0 3px 10px rgba(0,0,0,0.15);
      z-index: 9999;
      animation: fadeInOut 3s ease;
    }

    @keyframes fadeInOut {
      0% { opacity: 0; transform: translateY(-10px); }
      10%, 90% { opacity: 1; transform: translateY(0); }
      100% { opacity: 0; transform: translateY(-10px); }
    }

    input.edit-price {
      width: 100px;
      padding: 4px;
      border: 1px solid #ccc;
      border-radius: 6px;
    }
  </style>
</head>
<body>
  <div class="profile-container">
    <h2>Mening e‚Äôlonlarim</h2>
    <div id="my-ads"></div>
  </div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSy...",
      authDomain: "shahartaxi.firebaseapp.com",
      databaseURL: "https://shahartaxi-default-rtdb.firebaseio.com",
      projectId: "shahartaxi",
      storageBucket: "shahartaxi.appspot.com",
      messagingSenderId: "123456789",
      appId: "1:123456789:web:abcdef123456"
    };
    firebase.initializeApp(firebaseConfig);

    const userPhone = localStorage.getItem("userPhone");
    const adsRef = firebase.database().ref("ads");

    adsRef.on("value", snapshot => {
      const data = snapshot.val();
      const userAds = [];
      for (let id in data) {
        if (data[id].phone === userPhone) {
          userAds.push({ id, ...data[id] });
        }
      }
      renderMyAds(userAds.reverse());
    });

    function renderMyAds(ads) {
      const container = document.getElementById("my-ads");
      container.innerHTML = "";

      ads.forEach(ad => {
        const adCard = document.createElement("div");
        adCard.classList.add("ad-card");

        // Rang statusga qarab
        let bgColor = "#fff";
        if (ad.status === "Tasdiqlangan") bgColor = "#d4edda";
        else if (ad.status === "Rad etilgan") bgColor = "#f8d7da";
        else if (ad.status === "Kutilmoqda") bgColor = "#fff3cd";
        adCard.style.backgroundColor = bgColor;

        adCard.innerHTML = `
          <div class="ad-header">
            <h3>${ad.fromRegion} ‚Üí ${ad.toRegion}</h3>
            <span class="status">${ad.status}</span>
          </div>
          <p><strong>Narx:</strong> <span class="ad-price">${ad.price}</span> so‚Äòm</p>
          <p><strong>Yo‚Äònalish:</strong> ${ad.fromDistrict || ''} ‚Üí ${ad.toDistrict || ''}</p>
          <p><strong>Telefon:</strong> ${ad.phone}</p>
          <div class="ad-actions">
            <button class="edit-btn">‚úèÔ∏è Tahrirlash</button>
            <button class="delete-btn">üóëÔ∏è O‚Äòchirish</button>
          </div>
        `;

        // === Tahrirlash funksiyasi ===
        const editBtn = adCard.querySelector(".edit-btn");
        editBtn.addEventListener("click", () => {
          const priceEl = adCard.querySelector(".ad-price");
          const oldPrice = priceEl.textContent;
          priceEl.outerHTML = `<input type="number" class="edit-price" value="${oldPrice}" />`;

          const actions = adCard.querySelector(".ad-actions");
          actions.innerHTML = `
            <button class="save-btn">üíæ Saqlash</button>
            <button class="cancel-btn">‚ùå Bekor qilish</button>
          `;

          const saveBtn = actions.querySelector(".save-btn");
          const cancelBtn = actions.querySelector(".cancel-btn");
          const inputEl = adCard.querySelector(".edit-price");

          saveBtn.addEventListener("click", () => {
            const newPrice = inputEl.value;
            if (!newPrice) {
              alert("Narxni kiriting!");
              return;
            }

            firebase.database().ref(`ads/${ad.id}`).update({
              price: newPrice,
              lastEdited: new Date().toISOString()
            }).then(() => {
              showNotification("‚úÖ E‚Äôlon muvaffaqiyatli yangilandi!");
            });

            inputEl.outerHTML = `<span class="ad-price">${newPrice}</span>`;
            actions.innerHTML = `<span style="color:gray;">üîí Narx tahrirlandi</span>`;
          });

          cancelBtn.addEventListener("click", () => {
            inputEl.outerHTML = `<span class="ad-price">${oldPrice}</span>`;
            actions.innerHTML = `
              <button class="edit-btn">‚úèÔ∏è Tahrirlash</button>
              <button class="delete-btn">üóëÔ∏è O‚Äòchirish</button>
            `;
          });
        });

        // === O‚Äòchirish funksiyasi ===
        const deleteBtn = adCard.querySelector(".delete-btn");
        deleteBtn.addEventListener("click", () => {
          if (confirm("E‚Äôlonni o‚Äòchirishni xohlaysizmi?")) {
            firebase.database().ref(`ads/${ad.id}`).remove().then(() => {
              showNotification("üóëÔ∏è E‚Äôlon o‚Äòchirildi!");
            });
          }
        });

        container.appendChild(adCard);
      });
    }

    function showNotification(msg) {
      const note = document.createElement("div");
      note.classList.add("notification");
      note.textContent = msg;
      document.body.appendChild(note);
      setTimeout(() => note.remove(), 3000);
    }
  </script>
</body>
</html>
